# Tk 界面使用说明

- **入口**：`python -m client.tk_main`
- **两阶段体验**
  - *登录窗口*：独立 Tk 窗口，包含服务器 IP、账号、密码输入以及“登录 / 注册并登录”按钮，可显式指定目标服务器（写入 `CLIENT_CONFIG["server_host"]`）。登录成功后自动销毁并进入主界面。
  - *主界面*：顶部展示当前服务器与登录用户，并提供“退出登录”按钮；退出后可重新唤起登录窗口。
- **主界面布局**
  - *会话列表*：左侧 Treeview 按“双人通信 / 群聊 / 系统”分组列出会话。私聊标题形如“`双人通信：user1-user2`”，群聊为“`群聊：房间名`”。每个会话维护未读计数，未读时在标题后追加“`(未读N)`”提示；选中即可清零并只显示该会话的消息记录。
  - *在线用户*：保留在左侧，调用 `PresenceManager.request_roster()`，通过“刷新在线列表”按钮实时获取。
  - *房间管理*：主界面保留“房间管理”按钮，点击后弹出 `Toplevel` 弹窗，弹窗包含两个 Tab：
    1. **房间概览**：表格显示当前用户所在房间，列出房间 ID、加密状态、成员数，支持双击直接切换到对应会话，并可一键刷新/批量拉取成员列表。
    2. **房间操作**：提供创建（带加密勾选）、加入、离开房间等操作表单，提交后即时在弹窗中反馈成功/失败，并回调刷新主界面会话树。
  - *消息记录*：中央区域仅展示当前会话的消息，系统日志也被拆分到“系统”会话，便于排查。
  - *消息发送*：右下角输入区可在“私聊 / 房间”模式之间切换，内部依旧调用 `MessagingManager.send_text` / `send_room_text`，会话切换时会自动填充会话 ID 与目标 ID。
- **实现细节**
  - Tk 主线程仅负责 UI 绘制与事件绑定；`ClientRuntime` 在后台 asyncio 事件循环中运行，通过线程安全队列与 UI 通信，负责心跳、消息监听与离线补偿。
  - 登录窗口、主界面、房间弹窗都复用同一个 `ClientRuntime` 实例，因此网络状态与会话管理在多窗口之间保持一致。
