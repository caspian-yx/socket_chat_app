# 消息引用回复功能使用指南

## ✅ 功能概述

现在支持引用回复功能，类似微信、Telegram的引用消息功能。用户可以右键点击任意消息进行引用回复。

---

## 🎨 使用方法

### 1. 引用消息

**步骤**：
1. 在聊天窗口中，**右键点击**要引用的消息
2. 在弹出菜单中选择 **"📝 引用回复"**
3. 输入框上方会显示引用预览框
4. 输入你的回复内容
5. 点击 **"📤 发送"** 或按 **Enter** 键发送

### 2. 取消引用

**方法一**：点击引用预览框右上角的 **"✕"** 按钮
**方法二**：发送消息后自动清除引用

---

## 💬 显示效果

### 引用预览（发送前）

当你选择引用消息后，输入框上方会显示：

```
┌──────────────────────────────────┐
│ 💬 引用回复                    ✕ │
│ 回复 alice：你好，我是 Alice...  │
└──────────────────────────────────┘
```

### 引用消息（发送后）

发送引用回复后，消息会这样显示：

```
  ┌ 引用 [14:23:45] alice: 你好，我是 Alice
[14:24:10] [bob] 你好，很高兴认识你！
```

---

## 🌟 功能特性

### 1. 智能引用识别

- **自动解析消息**：系统自动识别消息的时间、发送者和内容
- **消息追踪**：通过消息ID追踪引用关系
- **跨会话引用**：在同一会话中引用任意历史消息

### 2. 引用信息保留

引用消息包含以下信息：
- **发送者**：被引用消息的发送者用户名
- **时间**：被引用消息的发送时间（HH:MM:SS）
- **内容**：被引用消息的文本（最多显示50字符）
- **消息ID**：用于追踪引用关系

### 3. 显示优化

- **缩进显示**：引用消息带有缩进，与正文区分
- **符号标识**：使用 "┌" 符号标识引用开始
- **长度限制**：引用内容超过50字符自动截断并添加 "..."
- **颜色区分**：引用消息使用不同颜色显示（灰色背景）

---

## 📝 使用场景

### 场景 1：回复特定问题

```
[14:20:00] [alice] 明天的会议几点开始？
[14:20:30] [bob] 大家都确认了吗？
  ┌ 引用 [14:20:00] alice: 明天的会议几点开始？
[14:21:00] [caspian] 明天下午3点开始
```

### 场景 2：确认信息

```
[14:25:00] [alice] 我发了一份文件给你
  ┌ 引用 [14:25:00] alice: 我发了一份文件给你
[14:25:30] [bob] 收到了，谢谢！
```

### 场景 3：多人讨论

```
[14:30:00] [alice] 这个设计方案怎么样？
[14:30:15] [bob] 我觉得不错
  ┌ 引用 [14:30:00] alice: 这个设计方案怎么样？
[14:30:45] [caspian] 我同意，但需要调整颜色
```

---

## 🔧 技术实现

### 协议层修改

#### 消息格式

引用消息在 `content` 字段中添加 `reply_to` 属性：

```json
{
  "command": "message/send",
  "payload": {
    "conversation_id": "alice|bob",
    "target": {"type": "user", "id": "bob"},
    "content": {
      "type": "text",
      "text": "你好，很高兴认识你！",
      "reply_to": {
        "message_id": "msg_12345",
        "sender": "alice",
        "text": "你好，我是 Alice",
        "time_str": "14:23:45"
      }
    }
  }
}
```

### UI层实现

#### 1. 引用预览框架 (client/ui/tk_chat.py:1005-1047)

```python
# 引用预览区域（默认隐藏）
self.reply_preview_frame = tk.Frame(composer, bg=ModernStyle.COLORS["card_bg"])

# 包含：
- 标题标签："💬 引用回复"
- 取消按钮："✕"
- 预览内容：显示被引用消息的简要信息
```

#### 2. 右键菜单 (client/ui/tk_chat.py:900-903)

```python
# 添加右键菜单用于引用回复
self.chat_context_menu = tk.Menu(self.chat_display, tearoff=0)
self.chat_context_menu.add_command(label="📝 引用回复", command=self._quote_selected_message)
self.chat_display.bind("<Button-3>", self._show_context_menu)
```

#### 3. 核心方法

**显示右键菜单** (`_show_context_menu`):
- 获取鼠标点击位置的消息
- 解析消息格式
- 显示菜单

**引用消息** (`_quote_selected_message`):
- 提取消息的时间、发送者、内容
- 从消息注册表查找消息ID
- 设置引用状态
- 显示引用预览

**取消引用** (`_cancel_reply`):
- 清除引用状态
- 隐藏引用预览框

**发送消息** (`_send_message`):
- 携带引用信息发送
- 发送后自动清除引用

### 消息层修改

#### MessagingManager (client/features/messaging.py)

```python
async def send_text(
    self, conversation_id: str,
    target_id: str,
    text: str,
    reply_to: Optional[Dict[str, Any]] = None
) -> None:
    content: Dict[str, Any] = {"type": "text", "text": text}
    if reply_to:
        content["reply_to"] = reply_to
    # ... 发送消息
```

#### ClientRuntime (client/ui/tk_chat.py)

```python
async def send_direct(
    self, conversation_id: str,
    target_id: str,
    text: str,
    reply_to: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    await self.messaging.send_text(conversation_id, target_id, text, reply_to)
    return {"conversation_id": conversation_id, "target_id": target_id, "text": text, "reply_to": reply_to}
```

---

## 🎯 显示逻辑

### 消息添加流程

1. **接收消息** (`_append_message`):
   - 从 payload 中提取 `reply_to` 信息
   - 传递给 `_add_message_to_conversation`

2. **添加到会话** (`_add_message_to_conversation`):
   - 保存消息到 `message_registry`（用于后续引用查找）
   - 如果有引用，先添加引用信息行
   - 再添加正文消息行

3. **显示格式**:
   ```
   引用行：  ┌ 引用 [时间] 发送者: 内容...
   正文行：[时间] [发送者] 消息内容
   ```

---

## 💡 使用技巧

### 1. 快速引用最近消息

在活跃的群聊中，可以快速右键点击最近的消息进行引用回复，保持讨论的连贯性。

### 2. 多人对话中明确回复对象

在多人群聊中，使用引用回复可以明确表明你在回复谁的消息。

### 3. 引用历史消息

可以引用会话中的任何历史消息，即使消息已经滚动到屏幕外。

---

## ⚠️ 注意事项

### 1. 引用长度限制

引用预览和显示都会截断长消息：
- **预览框**：显示前50个字符
- **消息显示**：显示前50个字符
- 超过部分用 "..." 表示

### 2. 消息ID追踪

系统通过消息ID追踪引用关系：
- **有消息ID**：可以精确追踪引用
- **无消息ID**：使用行号作为临时ID（重启后会丢失）

### 3. 跨会话引用

当前版本不支持跨会话引用（例如在会话A中引用会话B的消息）。

### 4. 历史消息引用

重新登录后：
- 已发送的引用消息会保留引用信息
- 可以继续引用历史消息

---

## 🧪 测试步骤

### 测试 1：基本引用回复

1. **Alice 发送消息**：
   ```
   [14:20:00] [alice] 你好，Bob！
   ```

2. **Bob 引用回复**：
   - 右键点击 alice 的消息
   - 选择 "📝 引用回复"
   - 输入：`你好，很高兴见到你`
   - 发送

3. **预期结果**：
   ```
   [14:20:00] [alice] 你好，Bob！
     ┌ 引用 [14:20:00] alice: 你好，Bob！
   [14:20:30] [bob] 你好，很高兴见到你
   ```

### 测试 2：群聊引用回复

1. **多人发送消息**：
   ```
   [14:30:00] [alice] 大家好！
   [14:30:10] [bob] 你好 Alice
   [14:30:15] [caspian] 大家好
   ```

2. **Alice 引用 bob 的消息**：
   - 右键点击 bob 的消息
   - 引用回复：`你好！`

3. **预期结果**：
   ```
   [14:30:00] [alice] 大家好！
   [14:30:10] [bob] 你好 Alice
   [14:30:15] [caspian] 大家好
     ┌ 引用 [14:30:10] bob: 你好 Alice
   [14:30:30] [alice] 你好！
   ```

### 测试 3：取消引用

1. **选择引用**：右键点击消息，选择引用
2. **查看预览**：确认引用预览框显示
3. **取消引用**：点击 "✕" 按钮
4. **预期结果**：引用预览框消失

### 测试 4：长消息引用

1. **发送长消息**：发送超过50字符的消息
2. **引用长消息**：右键引用该消息
3. **预期结果**：
   - 预览框显示前50字符 + "..."
   - 发送后的引用也显示前50字符 + "..."

---

## 📊 数据流程

```
用户操作流程：
┌─────────────────────────────────────────────┐
│ 1. 用户右键点击消息                        │
│    ↓                                        │
│ 2. 显示右键菜单                            │
│    ↓                                        │
│ 3. 用户选择"引用回复"                     │
│    ↓                                        │
│ 4. 解析消息（时间、发送者、内容）         │
│    ↓                                        │
│ 5. 查找消息ID（从message_registry）       │
│    ↓                                        │
│ 6. 设置reply_to_message状态               │
│    ↓                                        │
│ 7. 显示引用预览框                          │
│    ↓                                        │
│ 8. 用户输入回复内容                        │
│    ↓                                        │
│ 9. 点击发送按钮                            │
│    ↓                                        │
│ 10. 构造包含reply_to的消息                │
│    ↓                                        │
│ 11. 发送到服务器                           │
│    ↓                                        │
│ 12. 清除引用状态和预览                     │
└─────────────────────────────────────────────┘

接收消息流程：
┌─────────────────────────────────────────────┐
│ 1. 接收包含reply_to的消息                  │
│    ↓                                        │
│ 2. 提取reply_to信息                        │
│    ↓                                        │
│ 3. 显示引用行（带缩进）                    │
│    ↓                                        │
│ 4. 显示正文消息行                          │
│    ↓                                        │
│ 5. 保存到message_registry                 │
└─────────────────────────────────────────────┘
```

---

## 🎉 功能优势

### 1. 提升对话连贯性

在多人群聊或讨论中，引用回复能明确表示你在回复哪条消息，避免混淆。

### 2. 改善用户体验

- **简单直观**：右键点击即可引用
- **即时预览**：发送前可以看到引用内容
- **快速取消**：一键取消引用

### 3. 保留对话上下文

引用消息会显示原始消息的发送者和时间，保留完整的对话上下文。

---

## 🚀 未来可能的增强

1. **点击跳转**：点击引用消息可以跳转到原始消息位置
2. **引用链**：支持引用的消息再被引用，形成引用链
3. **跨会话引用**：支持在不同会话中引用消息
4. **多级引用**：显示多层引用关系
5. **引用统计**：统计某条消息被引用的次数

---

## ✨ 总结

引用回复功能已完全集成到聊天系统中，支持：

- ✅ 右键点击消息引用
- ✅ 引用预览显示
- ✅ 私聊和群聊引用
- ✅ 引用信息保留
- ✅ 优雅的显示格式
- ✅ 一键取消引用

现在就启动客户端，体验全新的引用回复功能吧！ 🎊
